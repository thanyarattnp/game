<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Snakes & Ladders: Set Algebra</title>
  <style>
    :root { --cell: 52px; --gap: 6px; --radius: 14px; }
    body { margin: 0; font-family: system-ui, sans-serif; background:#0b1220; color:#e8eefc; }
    header { padding: 14px 16px; display:flex; gap:12px; align-items:center; justify-content:space-between; border-bottom:1px solid #1f2a44; }
    .wrap { display:grid; grid-template-columns: 1.1fr 0.9fr; gap: 14px; padding: 14px; }
    .card { background:#0f1a30; border:1px solid #1f2a44; border-radius: var(--radius); padding: 12px; box-shadow: 0 8px 24px rgba(0,0,0,.25); }
    h1 { font-size: 16px; margin: 0; letter-spacing:.2px; }
    .muted { color:#b8c7ee; font-size: 12px; }
    button { border:0; background:#2b57ff; color:white; padding: 10px 12px; border-radius: 12px; cursor:pointer; font-weight: 650; }
    button:disabled { opacity:.45; cursor:not-allowed; }
    .btn2 { background:#1b2b55; border:1px solid #2a3d73; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .pill { background:#132246; border:1px solid #223565; padding:6px 10px; border-radius: 999px; font-size: 12px; }
    .board {
      position: relative;
      display:grid;
      grid-template-columns: repeat(10, var(--cell));
      grid-template-rows: repeat(10, var(--cell));
      gap: var(--gap);
      user-select:none;
      justify-content:center;
      padding: 10px;
      border-radius: var(--radius);
      background: radial-gradient(1200px 600px at 30% 20%, rgba(43,87,255,.18), transparent 60%),
                  radial-gradient(900px 500px at 70% 80%, rgba(255,122,66,.12), transparent 60%),
                  #0b1328;
      border:1px solid #1f2a44;
    }
    .cell {
      background:#0f1a30;
      border:1px solid #1f2a44;
      border-radius: 12px;
      display:flex;
      align-items:flex-start;
      justify-content:flex-end;
      padding:6px;
      font-size:12px;
      color:#b8c7ee;
      position: relative;
      overflow:hidden;
    }
    .cell .tag {
      position:absolute; left:8px; bottom:6px;
      font-size:11px; color:#d6ddff;
      opacity:.85;
    }
    .cell.special { outline: 2px solid rgba(43,87,255,.35); }
    .cell.snake { outline: 2px solid rgba(255, 80, 80, .35); }
    .cell.ladder { outline: 2px solid rgba(80, 255, 160, .35); }

    /* tokens */
    .tokens { position:absolute; inset: 0; pointer-events:none; }
    .token {
      position:absolute;
      width: 16px; height: 16px;
      border-radius: 999px;
      border:2px solid rgba(255,255,255,.9);
      box-shadow: 0 6px 18px rgba(0,0,0,.35);
      transform: translate(-50%, -50%);
    }
    .legend { display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-top:10px; }
    .team { display:flex; gap:10px; align-items:center; padding:8px; border-radius: 12px; border:1px solid #1f2a44; background:#0b1328; }
    .dot { width:14px; height:14px; border-radius:999px; border:2px solid rgba(255,255,255,.85); }
    .team b { font-size: 13px; }
    .team small { display:block; color:#b8c7ee; font-size: 12px; margin-top:2px; }

    /* modal */
    .modal {
      position: fixed; inset:0; display:none; place-items:center;
      background: rgba(0,0,0,.6);
      padding: 16px;
    }
    .modal.open { display:grid; }
    .modal .box {
      width: min(760px, 100%);
      background:#0f1a30;
      border:1px solid #2a3d73;
      border-radius: 18px;
      padding: 14px;
      box-shadow: 0 18px 60px rgba(0,0,0,.45);
    }
    .q-head { display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .q-title { font-size: 14px; font-weight: 750; }
    .q-timer { font-variant-numeric: tabular-nums; }
    .choices { margin-top:10px; display:grid; gap:8px; }
    label.choice {
      display:flex; gap:10px; align-items:flex-start;
      padding: 10px; border-radius: 12px;
      border:1px solid #1f2a44; background:#0b1328;
      cursor:pointer;
    }
    label.choice input { margin-top:2px; }
    .foot { display:flex; justify-content:space-between; align-items:center; gap:10px; margin-top:12px; }
    .log { max-height: 260px; overflow:auto; font-size:12px; color:#c8d3ff; line-height:1.4; }
    .log div { padding:6px 0; border-bottom:1px dashed rgba(255,255,255,.08); }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; background:#0b1328; border:1px solid #1f2a44; padding:2px 6px; border-radius:8px; font-size:12px; }
  </style>
</head>
<body>
<header>
  <div>
    <h1>üé≤ ‡∏ö‡∏±‡∏ô‡πÑ‡∏î‡∏á‡∏π: ‡∏û‡∏µ‡∏ä‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏Ç‡∏≠‡∏á‡πÄ‡∏ã‡∏ï (Set Algebra)</h1>
    <div class="muted">6 ‡∏ó‡∏µ‡∏° ‚Ä¢ ‡∏ï‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡πÄ‡∏î‡∏¥‡∏ô ‚Ä¢ ‡∏°‡∏µ‡∏ö‡∏±‡∏ô‡πÑ‡∏î/‡∏á‡∏π + ‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ + Log</div>
  </div>
  <div class="row">
    <button class="btn2" id="resetBtn">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏Å‡∏°</button>
    <button id="rollBtn">‡∏ó‡∏≠‡∏¢‡πÄ‡∏ï‡πã‡∏≤</button>
  </div>
</header>

<div class="wrap">
  <div class="card">
    <div class="row" style="justify-content:space-between;">
      <div class="row">
        <span class="pill">‡∏ï‡∏≤‡πÄ‡∏•‡πà‡∏ô: <b id="turnName"></b></span>
        <span class="pill">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á: <b id="turnPos"></b></span>
        <span class="pill">‡πÅ‡∏ï‡πâ‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: <b id="lastRoll">-</b></span>
      </div>
      <div class="row">
        <span class="pill">‡∏ä‡∏ô‡∏∞‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏≠‡∏á <b>100</b></span>
        <span class="pill">‡∏ï‡∏≠‡∏ö‡∏ú‡∏¥‡∏î‡πÄ‡∏î‡∏¥‡∏ô <b>1</b> ‡∏ä‡πà‡∏≠‡∏á</span>
      </div>
    </div>

    <div style="margin-top:12px;">
      <div class="board" id="board"></div>
      <div class="muted" style="margin-top:8px;">
        Tip: ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏£‡∏≠‡∏ö‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß = ‡∏ö‡∏±‡∏ô‡πÑ‡∏î, ‡∏Å‡∏£‡∏≠‡∏ö‡πÅ‡∏î‡∏á = ‡∏á‡∏π (‡πÄ‡∏ô‡πâ‡∏ô misconception)
      </div>
    </div>
  </div>

  <div class="card">
    <div class="row" style="justify-content:space-between;">
      <div>
        <div style="font-weight:800;">‡∏ó‡∏µ‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
        <div class="muted">‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ 30 ‡∏Ñ‡∏ô = 6 ‡∏ó‡∏µ‡∏° ‡∏ó‡∏µ‡∏°‡∏•‡∏∞ 5 ‡∏Ñ‡∏ô</div>
      </div>
      <div class="row">
        <button class="btn2" id="editTeamsBtn">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡∏°</button>
      </div>
    </div>

    <div class="legend" id="teamList"></div>

    <div style="margin-top:12px;">
      <div style="font-weight:800; margin-bottom:6px;">Log ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô</div>
      <div class="log" id="log"></div>
    </div>

    <div style="margin-top:10px;" class="muted">
      ‡∏Ñ‡∏µ‡∏¢‡πå‡∏•‡∏±‡∏î: <span class="kbd">Space</span> ‡∏ó‡∏≠‡∏¢‡πÄ‡∏ï‡πã‡∏≤ ‚Ä¢ <span class="kbd">Esc</span> ‡∏õ‡∏¥‡∏î‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°
    </div>
  </div>
</div>

<!-- QUESTION MODAL -->
<div class="modal" id="qModal" aria-hidden="true">
  <div class="box">
    <div class="q-head">
      <div>
        <div class="q-title" id="qTitle">‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°</div>
        <div class="muted" id="qMeta"></div>
      </div>
      <div class="pill">‡πÄ‡∏ß‡∏•‡∏≤: <b class="q-timer" id="qTimer">30</b>s</div>
    </div>

    <div id="qPrompt" style="margin-top:10px; font-size:14px; font-weight:650;"></div>
    <div class="choices" id="qChoices"></div>

    <div class="foot">
      <div class="muted" id="qHint"></div>
      <div class="row">
        <button class="btn2" id="skipBtn">‡∏Ç‡πâ‡∏≤‡∏° (‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏ú‡∏¥‡∏î)</button>
        <button id="submitBtn">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</button>
      </div>
    </div>
  </div>
</div>

<script>
/** =========================
 *  CONFIG / DATA
 *  ========================= */

// 6 ‡∏ó‡∏µ‡∏° (‡∏õ‡∏£‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏î‡πâ)
let TEAMS = [
  { name: "‡∏ó‡∏µ‡∏° A", color: "#2b57ff", pos: 1, score: 0 },
  { name: "‡∏ó‡∏µ‡∏° B", color: "#ff7a42", pos: 1, score: 0 },
  { name: "‡∏ó‡∏µ‡∏° C", color: "#7bffb0", pos: 1, score: 0 },
  { name: "‡∏ó‡∏µ‡∏° D", color: "#ff4fa3", pos: 1, score: 0 },
  { name: "‡∏ó‡∏µ‡∏° E", color: "#ffd34a", pos: 1, score: 0 },
  { name: "‡∏ó‡∏µ‡∏° F", color: "#9a7bff", pos: 1, score: 0 },
];

// ‡∏ö‡∏±‡∏ô‡πÑ‡∏î/‡∏á‡∏π (map: start -> end)
const LADDER = new Map([
  [3,22],[8,26],[15,34],[21,39],[28,47],[36,55],[44,68],[59,79],
]);
const SNAKE = new Map([
  [24,7],[33,13],[41,20],[49,29],[58,37],[67,46],[75,54],[88,65],
]);

// ‡πÇ‡∏à‡∏ó‡∏¢‡πå‡πÅ‡∏ö‡∏ö multiple-choice (‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡πà‡∏≤‡∏¢‡∏Å‡πà‡∏≠‡∏ô) ‚Äî ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏¢ ‡πÜ
// note: answer = index ‡∏Ç‡∏≠‡∏á choices (0-based)
const QUESTION_BANK = [
  // Level 1
  { id:"L1-01", level:1, topic:"Identity", prompt:"‡∏Ç‡πâ‡∏≠‡πÉ‡∏î‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á?", choices:[
    "A ‚à™ ‚àÖ = ‚àÖ",
    "A ‚à™ ‚àÖ = A",
    "A ‚à© ‚àÖ = A",
    "A·∂ú ‚à™ A = ‚àÖ"
  ], answer:1, explain:"‡∏Å‡∏é‡πÄ‡∏≠‡∏Å‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå: A ‚à™ ‚àÖ = A" },

  { id:"L1-02", level:1, topic:"Complement", prompt:"‡∏Ç‡πâ‡∏≠‡πÉ‡∏î‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á?", choices:[
    "A ‚à© A·∂ú = ‚àÖ",
    "A ‚à™ A·∂ú = ‚àÖ",
    "A ‚à© U = ‚àÖ",
    "A ‚à™ U = A"
  ], answer:0, explain:"‡∏Å‡∏é‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏ï‡πá‡∏°: A ‚à© A·∂ú = ‚àÖ ‡πÅ‡∏•‡∏∞ A ‚à™ A·∂ú = U" },

  { id:"L1-03", level:1, topic:"Absorption", prompt:"‡∏¢‡∏∏‡∏ö‡∏£‡∏π‡∏õ‡∏ô‡∏¥‡∏û‡∏à‡∏ô‡πå: A ‚à™ (A ‚à© B) =", choices:[
    "A", "B", "A ‚à© B", "A ‚à™ B"
  ], answer:0, explain:"Absorption: A ‚à™ (A ‚à© B) = A" },

  { id:"L1-04", level:1, topic:"De Morgan", prompt:"(A ‚à™ B)·∂ú ‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡πÉ‡∏î?", choices:[
    "A·∂ú ‚à™ B·∂ú",
    "A·∂ú ‚à© B·∂ú",
    "A ‚à© B",
    "(A·∂ú)·∂ú ‚à© (B·∂ú)·∂ú"
  ], answer:1, explain:"De Morgan: (A ‚à™ B)·∂ú = A·∂ú ‚à© B·∂ú" },

  // Level 2
  { id:"L2-01", level:2, topic:"Difference", prompt:"A \\ B ‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡πÉ‡∏î?", choices:[
    "A ‚à™ B·∂ú",
    "A ‚à© B·∂ú",
    "A·∂ú ‚à© B",
    "(A ‚à© B)·∂ú"
  ], answer:1, explain:"Difference: A \\ B = A ‚à© B·∂ú" },

  { id:"L2-02", level:2, topic:"Simplify", prompt:"‡∏¢‡∏∏‡∏ö‡∏£‡∏π‡∏õ: (A ‚à© B) ‚à™ (A ‚à© B·∂ú) =", choices:[
    "A", "B", "A ‚à© B", "A ‚à™ B"
  ], answer:0, explain:"‡∏î‡∏∂‡∏á A ‡∏≠‡∏≠‡∏Å: A ‚à© (B ‚à™ B·∂ú) = A ‚à© U = A" },

  // Level 3
  { id:"L3-01", level:3, topic:"Distributive", prompt:"‡∏¢‡∏∏‡∏ö‡∏£‡∏π‡∏õ: (A ‚à™ B) ‚à© (A ‚à™ C) =", choices:[
    "A ‚à™ (B ‚à© C)",
    "(A ‚à© B) ‚à™ (A ‚à© C)",
    "A ‚à© (B ‚à™ C)",
    "(A ‚à™ B ‚à™ C)"
  ], answer:0, explain:"Distributive: (A ‚à™ B) ‚à© (A ‚à™ C) = A ‚à™ (B ‚à© C)" },
];

/** =========================
 *  STATE
 *  ========================= */
let turn = 0;
let pendingRoll = null;      // ‡πÅ‡∏ï‡πâ‡∏°‡πÄ‡∏ï‡πã‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏≠‡πÉ‡∏ä‡πâ
let pendingQuestion = null;  // ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ñ‡∏≤‡∏°
let timerId = null;
let timeLeft = 30;
const USED_Q = new Set();

/** =========================
 *  UI ELEMENTS
 *  ========================= */
const boardEl = document.getElementById("board");
const teamListEl = document.getElementById("teamList");
const logEl = document.getElementById("log");

const rollBtn = document.getElementById("rollBtn");
const resetBtn = document.getElementById("resetBtn");
const editTeamsBtn = document.getElementById("editTeamsBtn");

const turnNameEl = document.getElementById("turnName");
const turnPosEl = document.getElementById("turnPos");
const lastRollEl = document.getElementById("lastRoll");

const qModal = document.getElementById("qModal");
const qTitle = document.getElementById("qTitle");
const qMeta = document.getElementById("qMeta");
const qPrompt = document.getElementById("qPrompt");
const qChoices = document.getElementById("qChoices");
const qHint = document.getElementById("qHint");
const qTimer = document.getElementById("qTimer");
const submitBtn = document.getElementById("submitBtn");
const skipBtn = document.getElementById("skipBtn");

/** =========================
 *  HELPERS
 *  ========================= */
function log(msg) {
  const d = document.createElement("div");
  const t = new Date().toLocaleTimeString("th-TH", { hour12:false });
  d.textContent = `[${t}] ${msg}`;
  logEl.prepend(d);
}

function currentTeam() { return TEAMS[turn]; }

function rollDice() {
  // 1..6
  return Math.floor(Math.random()*6)+1;
}

function clampTo100(pos) { return pos > 100 ? 100 : pos; }

function nextTurn() {
  pendingRoll = null;
  pendingQuestion = null;
  stopTimer();
  turn = (turn + 1) % TEAMS.length;
  updateHUD();
}

function updateHUD() {
  turnNameEl.textContent = currentTeam().name;
  turnPosEl.textContent = currentTeam().pos;
  lastRollEl.textContent = pendingRoll ?? "-";
}

function getCellNumberByGridIndex(i) {
  // ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏ß‡∏≤‡∏î 100..1 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏ô‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡πÑ‡∏î‡∏á‡∏π (‡πÅ‡∏ñ‡∏ß‡∏ö‡∏ô‡πÄ‡∏õ‡πá‡∏ô 100)
  // ‡πÅ‡∏•‡∏∞‡∏™‡∏•‡∏±‡∏ö‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢-‡∏Ç‡∏ß‡∏≤‡∏ó‡∏∏‡∏Å‡πÅ‡∏ñ‡∏ß (serpentine)
  const row = Math.floor(i / 10);        // 0..9
  const col = i % 10;                    // 0..9
  const base = 100 - row*10;             // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ç‡∏≠‡∏á‡πÅ‡∏ñ‡∏ß‡∏ô‡∏±‡πâ‡∏ô
  const isEvenRow = row % 2 === 0;       // ‡πÅ‡∏ñ‡∏ß 0 (‡∏ö‡∏ô‡∏™‡∏∏‡∏î) ‡πÄ‡∏î‡∏¥‡∏ô‡∏ã‡πâ‡∏≤‡∏¢->‡∏Ç‡∏ß‡∏≤? ‡πÄ‡∏£‡∏≤‡∏à‡∏±‡∏î‡πÉ‡∏´‡πâ serpentine
  const n = isEvenRow ? (base - col) : (base - (9 - col));
  return n;
}

function cellCenterPx(cellEl) {
  const r = cellEl.getBoundingClientRect();
  const b = boardEl.getBoundingClientRect();
  return { x: r.left - b.left + r.width/2, y: r.top - b.top + r.height/2 };
}

function randomQuestion(levelPref = null) {
  // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ ‡∏ñ‡πâ‡∏≤‡∏´‡∏°‡∏î‡πÉ‡∏´‡πâ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï USED_Q
  let pool = QUESTION_BANK.filter(q => !USED_Q.has(q.id));
  if (pool.length === 0) {
    USED_Q.clear();
    pool = QUESTION_BANK.slice();
  }
  if (levelPref) pool = pool.filter(q => q.level === levelPref);
  if (pool.length === 0) pool = QUESTION_BANK.filter(q => !USED_Q.has(q.id));
  const q = pool[Math.floor(Math.random()*pool.length)];
  USED_Q.add(q.id);
  return q;
}

function openQuestionModal(q) {
  pendingQuestion = q;
  qTitle.textContent = `‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° (Level ${q.level})`;
  qMeta.textContent = `‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠: ${q.topic} ‚Ä¢ ‡∏£‡∏´‡∏±‡∏™: ${q.id}`;
  qPrompt.textContent = q.prompt;

  qChoices.innerHTML = "";
  q.choices.forEach((c, idx) => {
    const lab = document.createElement("label");
    lab.className = "choice";
    lab.innerHTML = `
      <input type="radio" name="choice" value="${idx}" />
      <div>${c}</div>
    `;
    qChoices.appendChild(lab);
  });

  qHint.textContent = "‡∏ï‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å: ‡πÄ‡∏î‡∏¥‡∏ô‡∏ï‡∏≤‡∏°‡πÅ‡∏ï‡πâ‡∏° ‚Ä¢ ‡∏ï‡∏≠‡∏ö‡∏ú‡∏¥‡∏î/‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤: ‡πÄ‡∏î‡∏¥‡∏ô 1 ‡∏ä‡πà‡∏≠‡∏á";
  qModal.classList.add("open");
  qModal.setAttribute("aria-hidden","false");

  timeLeft = 30;
  qTimer.textContent = timeLeft;
  startTimer();
}

function closeQuestionModal() {
  qModal.classList.remove("open");
  qModal.setAttribute("aria-hidden","true");
  stopTimer();
}

function startTimer() {
  stopTimer();
  timerId = setInterval(() => {
    timeLeft--;
    qTimer.textContent = timeLeft;
    if (timeLeft <= 0) {
      stopTimer();
      resolveAnswer(false, "‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤");
    }
  }, 1000);
}
function stopTimer() {
  if (timerId) clearInterval(timerId);
  timerId = null;
}

function selectedChoiceIndex() {
  const el = document.querySelector('input[name="choice"]:checked');
  return el ? Number(el.value) : null;
}

function applySnakeLadder(pos) {
  if (LADDER.has(pos)) return { type:"ladder", to: LADDER.get(pos) };
  if (SNAKE.has(pos)) return { type:"snake", to: SNAKE.get(pos) };
  return null;
}

function moveTeam(steps) {
  const team = currentTeam();
  const from = team.pos;
  team.pos = clampTo100(team.pos + steps);

  log(`${team.name} ‡πÄ‡∏î‡∏¥‡∏ô‡∏à‡∏≤‡∏Å ${from} ‚Üí ${team.pos} (‡πÄ‡∏î‡∏¥‡∏ô ${steps})`);

  const sl = applySnakeLadder(team.pos);
  if (sl) {
    const before = team.pos;
    team.pos = sl.to;
    log(`${team.name} ‡πÄ‡∏à‡∏≠${sl.type === "ladder" ? "‡∏ö‡∏±‡∏ô‡πÑ‡∏î ü™ú" : "‡∏á‡∏π üêç"}: ${before} ‚Üí ${team.pos}`);
  }

  renderTokens();
  updateHUD();

  if (team.pos >= 100) {
    log(`üèÅ ${team.name} ‡∏ä‡∏ô‡∏∞‡πÅ‡∏•‡πâ‡∏ß!`);
    rollBtn.disabled = true;
    alert(`${team.name} ‡∏ä‡∏ô‡∏∞‡πÅ‡∏•‡πâ‡∏ß!`);
    return;
  }

  nextTurn();
}

function resolveAnswer(isCorrect, reason="") {
  const team = currentTeam();
  closeQuestionModal();

  const roll = pendingRoll ?? 0;
  const steps = isCorrect ? roll : 1;

  if (isCorrect) {
    team.score += 1;
    log(`‚úÖ ${team.name} ‡∏ï‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å (${pendingQuestion?.id}) ‚Üí ‡πÄ‡∏î‡∏¥‡∏ô ${roll}`);
  } else {
    log(`‚ùå ${team.name} ‡∏ï‡∏≠‡∏ö‡∏ú‡∏¥‡∏î/‡∏Ç‡πâ‡∏≤‡∏° (${pendingQuestion?.id}) ${reason ? "‚Ä¢ "+reason : ""} ‚Üí ‡πÄ‡∏î‡∏¥‡∏ô 1`);
    if (pendingQuestion?.explain) log(`‡πÄ‡∏â‡∏•‡∏¢‡∏™‡∏±‡πâ‡∏ô: ${pendingQuestion.explain}`);
  }

  moveTeam(steps);
}

/** =========================
 *  RENDER
 *  ========================= */
function renderBoard() {
  boardEl.innerHTML = "";
  for (let i=0; i<100; i++) {
    const n = getCellNumberByGridIndex(i);
    const cell = document.createElement("div");
    cell.className = "cell";
    cell.dataset.num = n;
    cell.innerHTML = `<div>${n}</div><div class="tag"></div>`;

    // tag ‡∏ä‡πà‡∏≠‡∏á‡∏û‡∏¥‡πÄ‡∏®‡∏©
    const tag = cell.querySelector(".tag");
    if (LADDER.has(n)) { cell.classList.add("ladder"); tag.textContent = `ü™ú‚Üí${LADDER.get(n)}`; }
    if (SNAKE.has(n))  { cell.classList.add("snake");  tag.textContent = `üêç‚Üí${SNAKE.get(n)}`; }
    if (LADDER.has(n) || SNAKE.has(n)) cell.classList.add("special");

    boardEl.appendChild(cell);
  }

  // layer tokens
  const layer = document.createElement("div");
  layer.className = "tokens";
  layer.id = "tokensLayer";
  boardEl.appendChild(layer);
}

function renderTeams() {
  teamListEl.innerHTML = "";
  TEAMS.forEach((t, idx) => {
    const el = document.createElement("div");
    el.className = "team";
    el.innerHTML = `
      <div class="dot" style="background:${t.color}"></div>
      <div>
        <b>${t.name}</b>
        <small>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á: ${t.pos} ‚Ä¢ ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: ${t.score}</small>
      </div>
    `;
    // ‡πÑ‡∏Æ‡πÑ‡∏•‡∏ï‡πå‡∏ï‡∏≤‡πÄ‡∏•‡πà‡∏ô
    if (idx === turn) el.style.borderColor = "#2b57ff";
    teamListEl.appendChild(el);
  });
}

function renderTokens() {
  const layer = document.getElementById("tokensLayer");
  layer.innerHTML = "";

  // ‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡∏°‡∏≠‡∏¢‡∏π‡πà‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô ‡∏à‡∏∞‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢ token ‡∏£‡∏≠‡∏ö ‡πÜ ‡∏à‡∏∏‡∏î‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏•‡∏≤‡∏á
  const groups = new Map(); // pos -> teams[]
  TEAMS.forEach((t, idx) => {
    if (!groups.has(t.pos)) groups.set(t.pos, []);
    groups.get(t.pos).push({t, idx});
  });

  groups.forEach((arr, pos) => {
    const cell = boardEl.querySelector(`.cell[data-num="${pos}"]`);
    if (!cell) return;
    const c = cellCenterPx(cell);

    const radius = 10;
    arr.forEach((item, k) => {
      const angle = (Math.PI*2) * (k / arr.length);
      const x = c.x + (arr.length === 1 ? 0 : Math.cos(angle)*radius);
      const y = c.y + (arr.length === 1 ? 0 : Math.sin(angle)*radius);

      const tok = document.createElement("div");
      tok.className = "token";
      tok.style.background = item.t.color;
      tok.style.left = x + "px";
      tok.style.top = y + "px";
      layer.appendChild(tok);
    });
  });

  renderTeams();
}

/** =========================
 *  GAME FLOW
 *  ========================= */
function doRoll() {
  if (pendingRoll !== null) return; // ‡∏Å‡∏±‡∏ô‡∏ó‡∏≠‡∏¢‡∏ã‡πâ‡∏≥
  const r = rollDice();
  pendingRoll = r;
  lastRollEl.textContent = r;

  // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢ ‡πÜ: ‡∏ä‡πà‡∏ß‡∏á‡∏ï‡πâ‡∏ô‡πÄ‡∏Å‡∏° level1 ‡∏Å‡∏•‡∏≤‡∏á game level2 ‡∏õ‡∏•‡∏≤‡∏¢ game level3
  const pos = currentTeam().pos;
  const levelPref = pos < 35 ? 1 : (pos < 70 ? 2 : 3);

  const q = randomQuestion(levelPref);
  log(`üé≤ ${currentTeam().name} ‡∏ó‡∏≠‡∏¢‡πÑ‡∏î‡πâ ${r} ‚Üí ‡πÄ‡∏õ‡∏¥‡∏î‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° ${q.id}`);
  openQuestionModal(q);
}

function resetGame() {
  TEAMS = TEAMS.map(t => ({...t, pos:1, score:0}));
  turn = 0;
  pendingRoll = null;
  pendingQuestion = null;
  USED_Q.clear();
  rollBtn.disabled = false;
  logEl.innerHTML = "";
  log("‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏Å‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
  updateHUD();
  renderTokens();
}

/** =========================
 *  EVENTS
 *  ========================= */
rollBtn.addEventListener("click", doRoll);
resetBtn.addEventListener("click", resetGame);

submitBtn.addEventListener("click", () => {
  const idx = selectedChoiceIndex();
  if (idx === null) { alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞"); return; }
  const ok = idx === pendingQuestion.answer;
  resolveAnswer(ok);
});

skipBtn.addEventListener("click", () => resolveAnswer(false, "‡∏Ç‡πâ‡∏≤‡∏°"));

editTeamsBtn.addEventListener("click", () => {
  const names = prompt("‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡∏°‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢ , (‡πÄ‡∏ä‡πà‡∏ô ‡∏ó‡∏µ‡∏°1,‡∏ó‡∏µ‡∏°2,...)",
                       TEAMS.map(t=>t.name).join(","));
  if (!names) return;
  const arr = names.split(",").map(s=>s.trim()).filter(Boolean);
  if (arr.length < 2) { alert("‡∏Ç‡∏≠‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 2 ‡∏ó‡∏µ‡∏°"); return; }

  // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ó‡∏µ‡∏°‡πÉ‡∏´‡∏°‡πà‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å (‡πÉ‡∏ä‡πâ‡∏™‡∏µ‡∏ß‡∏ô)
  const COLORS = ["#2b57ff","#ff7a42","#7bffb0","#ff4fa3","#ffd34a","#9a7bff","#4fd3ff","#ff6b6b"];
  TEAMS = arr.map((n,i)=>({ name:n, color:COLORS[i%COLORS.length], pos:1, score:0 }));
  turn = 0;
  updateHUD();
  renderTokens();
  log(`‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡∏°‡πÉ‡∏´‡∏°‡πà: ${arr.join(" / ")}`);
});

document.addEventListener("keydown", (e) => {
  if (e.code === "Space") { e.preventDefault(); if (!qModal.classList.contains("open")) doRoll(); }
  if (e.code === "Escape") { if (qModal.classList.contains("open")) resolveAnswer(false, "‡∏õ‡∏¥‡∏î‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°"); }
});

// close when click outside box
qModal.addEventListener("click", (e) => {
  if (e.target === qModal) resolveAnswer(false, "‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á");
});

/** =========================
 *  INIT
 *  ========================= */
renderBoard();
updateHUD();
renderTokens();
log("‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏•‡πà‡∏ô! ‡∏Å‡∏î‡∏ó‡∏≠‡∏¢‡πÄ‡∏ï‡πã‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢");
</script>
</body>
</html>
